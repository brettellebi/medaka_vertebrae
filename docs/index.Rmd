---
title: "Vertebrae variation in the MIKK panel"
author: "Ian Brettell"
date: '`r format(Sys.Date())`'
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    dev: 'svg'
    number_sections: true
    keep_md: false
    pandoc_args: --lua-filter=color-text.lua
    highlight: pygments
---

# Load libraries

```{r, message = F, warning = F}
library(here)
source(here::here("docs/source.R"))
```

# Read in data

```{r}
in_file = here::here("data/VC_ARC_F2_Crosses organised_counted_measured_new.xlsx")
```

## F0

```{r}
F0_sheet = "F0 VC with Measurements"

F0_data = readxl::read_xlsx(in_file, sheet = F0_sheet) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  # get line names
  tidyr::separate(Name, c("PAT", "GEN_FOCAL"), sep = " ") %>% 
  # get MAT
  dplyr::mutate(MAT = PAT) %>% 
  # get age
  dplyr::mutate(dplyr::across(c("DOS", "DOB"),
                              ~as.Date(.x, format = "%d.%m.%Y")),
                AGE = DOS - DOB) %>% 
  # remove un-needed columns
  dplyr::select(PAT,
                MAT,
                GEN_FOCAL, 
                SEX = Comments,
                AGE,
                ABD_CNT = Abdominal, CAU_CNT = Caudal, TOT_CNT = Total,
                ABD_LEN = "Abdominal length",
                CAU_LEN = "Caudal Length",
                TOT_LEN = "Total length",
                ABS_LEN = "Absolute length",
                ABD_2_CAU = "AV/CV",
                ABD_2_TOT = "AV/TL",
                CAU_2_TOT = "CV/TL",
                ABD_2_ABS = "AV/AL",
                CAU_2_ABS = "CV/AL")

```

## F1

```{r}
F1_sheet = "F1 VC with Measurements"

F1_data = readxl::read_xlsx(in_file, sheet = F1_sheet) %>% 
  dplyr::filter(complete.cases(.)) %>% 
  # get line names
  tidyr::separate(Name, c("LINE_A", "GEN_A", "SEX_A", NA, "LINE_B", "GEN_B", "SEX_B"), sep = " ") %>% 
  # get age
  dplyr::mutate(AGE = DOS - DOB) %>% 
  # get PAT and MAT line
  dplyr::mutate(PAT = dplyr::if_else(SEX_A == "Male", LINE_A, LINE_B),
                MAT = dplyr::if_else(SEX_A == "Female", LINE_A, LINE_B)) %>%
  # remove un-needed columns
  dplyr::select(PAT,
                MAT,
                GEN_A,
                GEN_B,
                SEX = Comments,
                AGE,
                ABD_CNT = Abdominal, CAU_CNT = Caudal, TOT_CNT = Total,
                ABD_LEN = "Abdominal length",
                CAU_LEN = "Caudal Length",
                TOT_LEN = "Total length",
                ABS_LEN = "Absolute length",
                ABD_2_CAU = "AV/CV",
                ABD_2_TOT = "AV/TL",
                CAU_2_TOT = "CV/TL",
                ABD_2_ABS = "AV/AL",
                CAU_2_ABS = "CV/AL")
  
```

## F2

```{r}
# Target sheets
F2_sheets = c("14-2 Female x 72-1 Male",
              "14-2 Male x 72-1 Female",
              "11-2 Male x14-2 Female",
              "11-2 Male x 72-1 Female")

# Read in 
F2_data = purrr::map(F2_sheets, function(SHEET){
  readxl::read_xlsx(in_file, sheet = SHEET) %>% 
    # remove Comments column
    dplyr::select(-Comments) %>% 
    # remove empty rows
    dplyr::filter(complete.cases(.)) %>% 
    # split `Name` to get info
    tidyr::separate(Name, c(NA, "NAME", NA), sep = "_") %>%
    # remove leading space from `NAME`
    dplyr::mutate(NAME = gsub("^ ", "", NAME)) %>% 
    # split new `NAME` to get parental line and sex
    tidyr::separate(NAME, c("SEX_A", "LINE_A", "GEN_A", NA, "SEX_B", "LINE_B", "GEN_B"), sep = " ")  %>% 
    # get PAT and MAT line
    dplyr::mutate(PAT = dplyr::if_else(SEX_A == "Male", LINE_A, LINE_B),
                  MAT = dplyr::if_else(SEX_A == "Female", LINE_A, LINE_B)) %>%
    # rename `Total Vertebrae` in the second two sheets as `Total` to make consistent with the first two
    dplyr::rename_with(dplyr::recode, `Total Vertebrae` = "Total") %>% 
    # remove un-needed columns
    dplyr::select(PAT,
                  MAT,
                  GEN_A,
                  GEN_B,
                  ABD_CNT = Abdominal, CAU_CNT = Caudal, TOT_CNT = Total,
                  ABD_LEN = `Abdominal  Length`,
                  CAU_LEN = `Caudal length`,
                  TOT_LEN = `Total vertebrae length`,
                  ABS_LEN = `Absolute length`,
                  ABD_2_CAU = "Abd/Cau",
                  ABD_2_TOT = "Abdominal/total vertebrae",
                  CAU_2_TOT = "Caudal/total vertebrae",
                  ABD_2_ABS = "Abd/Abs",
                  CAU_2_ABS = "Cau/Abs") %>% 
    # convert `CAU_LEN to numeric
    dplyr::mutate(CAU_LEN = as.numeric(CAU_LEN))
}) %>% 
  # bind into single DF
  dplyr::bind_rows()
```

## Combine into single DF

```{r}
df = list(F0 = F0_data,
          F1 = F1_data,
          F2 = F2_data) %>% 
  dplyr::bind_rows(.id = "CROSS_GEN") 

DT::datatable(df)
```

# Plot F0

Explore which measures show the biggest variation in F0

```{r}
count_measures = c("ABD_CNT",
                   "CAU_CNT",
                   "TOT_CNT")

length_measures = c("ABD_LEN",
                    "CAU_LEN",
                    "TOT_LEN",
                    "ABS_LEN")

ratio_measures = c("ABD_2_ABS",
                   "ABD_2_TOT",
                   "CAU_2_ABS",
                   "CAU_2_TOT",
                   "ABD_2_CAU")
```

## Counts

```{r}
df %>% 
  dplyr::filter(CROSS_GEN == "F0") %>% 
  # pivot longer
  tidyr::pivot_longer(cols = all_of(count_measures),
                      names_to = "MEASURE",
                      values_to = "VALUE") %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MEASURE = factor(MEASURE, levels = count_measures)) %>% 
  ggplot(aes(PAT, VALUE, colour = PAT, fill = PAT)) +
    geom_violin() +
    geom_boxplot(width = .3) +
    ggbeeswarm::geom_quasirandom(color="#66717E", size=0.4, alpha=0.9, groupOnX = T) +
    facet_grid(SEX ~ MEASURE) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ylim(0, NA) +
    ggtitle("F0 count measures: split sex") +
    xlab("Line") +
    ylab("Value") +
    guides(fill = "none",
           colour = "none")

df %>% 
  dplyr::filter(CROSS_GEN == "F0") %>% 
  # pivot longer
  tidyr::pivot_longer(cols = all_of(count_measures),
                      names_to = "MEASURE",
                      values_to = "VALUE") %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MEASURE = factor(MEASURE, levels = count_measures)) %>% 
  ggplot(aes(PAT, VALUE, colour = PAT, fill = PAT)) +
    geom_violin() +
    geom_boxplot(width = .3) +
    ggbeeswarm::geom_quasirandom(color="#66717E", size=0.4, alpha=0.9, groupOnX = T) +
    facet_grid(cols = vars(MEASURE)) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ylim(0, NA) +
    ggtitle("F0 count measures: all") +
    xlab("Line") +
    ylab("Value") +
    guides(fill = "none",
           colour = "none")    
```

## Lengths

```{r}
# Separated by sex
df %>% 
  dplyr::filter(CROSS_GEN == "F0") %>% 
  # pivot longer
  tidyr::pivot_longer(cols = all_of(length_measures),
                      names_to = "MEASURE",
                      values_to = "VALUE") %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MEASURE = factor(MEASURE, levels = length_measures)) %>% 
  ggplot(aes(PAT, VALUE, colour = PAT, fill = PAT)) +
    geom_violin() +
    geom_boxplot(width = .3) +
    ggbeeswarm::geom_quasirandom(color="#7D8491", size=0.4, alpha=0.9, groupOnX = T) +
    facet_grid(SEX ~ MEASURE) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ggtitle("F0 length measures: split sex") +
    xlab("Line") +
    ylab("Value") +
    guides(fill = "none",
           colour = "none")

# Consolidated sex
df %>% 
  dplyr::filter(CROSS_GEN == "F0") %>% 
  # pivot longer
  tidyr::pivot_longer(cols = all_of(length_measures),
                      names_to = "MEASURE",
                      values_to = "VALUE") %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MEASURE = factor(MEASURE, levels = length_measures)) %>% 
  ggplot(aes(PAT, VALUE, colour = PAT, fill = PAT)) +
    geom_violin() +
    geom_boxplot(width = .3) +
    ggbeeswarm::geom_quasirandom(color="#7D8491", size=0.4, alpha=0.9, groupOnX = T) +
    facet_grid(cols = vars(MEASURE)) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ggtitle("F0 length measures: all") +
    xlab("Line") +
    ylab("Value") +
    guides(fill = "none",
           colour = "none")
```

## Ratios

```{r}
# Separated by sex
df %>% 
  dplyr::filter(CROSS_GEN == "F0") %>% 
  # pivot longer
  tidyr::pivot_longer(cols = all_of(ratio_measures),
                      names_to = "MEASURE",
                      values_to = "VALUE") %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MEASURE = factor(MEASURE, levels = ratio_measures)) %>% 
  ggplot(aes(PAT, VALUE, colour = PAT, fill = PAT)) +
    geom_violin() +
    geom_boxplot(width = .3) +
    ggbeeswarm::geom_quasirandom(color="#7D8491", size=0.4, alpha=0.9, groupOnX = T) +
    facet_grid(SEX ~ MEASURE) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ylim(0,1) +
    ggtitle("F0 ratio measures: split sex") +
    xlab("Line") +
    ylab("Value") +
    guides(fill = "none",
           colour = "none")

# Consolidated sex
df %>% 
  dplyr::filter(CROSS_GEN == "F0") %>% 
  # pivot longer
  tidyr::pivot_longer(cols = all_of(ratio_measures),
                      names_to = "MEASURE",
                      values_to = "VALUE") %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MEASURE = factor(MEASURE, levels = ratio_measures)) %>% 
  ggplot(aes(PAT, VALUE, colour = PAT, fill = PAT)) +
    geom_violin() +
    geom_boxplot(width = .3) +
    ggbeeswarm::geom_quasirandom(color="#7D8491", size=0.4, alpha=0.9, groupOnX = T) +
    facet_grid(cols = vars(MEASURE)) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ylim(0,1) +
    ggtitle("F0 ratio measures: all") +
    xlab("Line") +
    ylab("Value") +
    guides(fill = "none",
           colour = "none")
```


# Plot F0 and F1 for absolute length

```{r}
df %>% 
  dplyr::filter(CROSS_GEN %in% c("F0", "F1")) %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MAT = factor(MAT, levels = rev(parental_lines))) %>% 
  ggplot(aes(PAT, ABS_LEN, colour = PAT, fill = MAT)) +
    geom_violin() +
    geom_boxplot(width = .3) +
    ggbeeswarm::geom_quasirandom(color="#7D8491", size=0.4, alpha=0.9, groupOnX = T) +
    facet_grid(MAT ~ CROSS_GEN ) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ggtitle("Absolute length of F0 and F1 generations") 
#    xlab("Line") +
#    ylab("Value") +
#    guides(fill = "none",
#           colour = "none")
```

# Plot all generations for absolute length

```{r, out.width='100%', fig.dim = c(12, 10)}
df %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MAT = factor(MAT, levels = rev(parental_lines))) %>% 
  ggplot(aes(PAT, ABS_LEN, colour = PAT, fill = MAT)) +
    geom_violin() +
    geom_boxplot(width = .3) +
    ggbeeswarm::geom_quasirandom(color="#7D8491", size=0.4, alpha=0.9, groupOnX = T) +
    facet_grid(MAT ~ CROSS_GEN ) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ggtitle("Absolute length of all generations") 
```

Strange that the F2 individuals are so much smaller than the F0 and F1 generations. Is it related to their age?

```{r}
# No age data for F2:
df %>% dplyr::filter(CROSS_GEN == "F2") %>% count(AGE)

# Plot for F0 and F1
df %>% 
  dplyr::filter(CROSS_GEN %in% c("F0", "F1")) %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MAT = factor(MAT, levels = rev(parental_lines))) %>% 
  ggplot(aes(AGE, ABS_LEN, colour = PAT, fill = MAT)) +
    geom_point(shape = 21) +
    facet_grid(MAT ~ CROSS_GEN ) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ggtitle("Absolute length of all generations") 
```

Can't tell anything about the effect of age on length because all the individuals in each group were assayed on the same day.

# Correlation between F2 vertebrae count and absolute length

```{r}
df %>% 
  dplyr::filter(CROSS_GEN == "F2") %>% 
  # order
  dplyr::mutate(PAT = factor(PAT, levels = parental_lines),
                MAT = factor(MAT, levels = rev(parental_lines))) %>% 
  ggplot() +
    geom_point(aes(TOT_CNT, ABS_LEN, colour = PAT, fill = MAT), shape = 21) +
    facet_grid(cols = vars(PAT), rows = vars(MAT)) +
    scale_colour_manual(values = darker(pal_ror, amount = 50)) +
    scale_fill_manual(values = pal_ror) +
    theme_bw() +
    ggtitle("Relationship between total vertebrae count and absolute length") 
```



